---
  title: "umap Analysis"
author: "Alonso Serrano"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
  

```{r}
library(DESeq2)

 library(tximport)
# library(BiocParallel)
# library(plotly)
# library(dplyr)
# library(here)
# register(MulticoreParam(4))
# source(here("Rtoolbox/src/utilsDE.r"))
# source(here("Rtoolbox/src/plot3Dvector.R"))
# source(here("Rtoolbox/src/plotVectorPCA.R"))
# source(here("Rtoolbox/src/plotUpAndDown.R"))

```


Set the project folder

```{r}
projectFolder <- "/mnt/picea/projects/spruce/vhurry/14_SpruceRoots_Project"
deFolder <- paste0(projectFolder,"/DE/")


meta <- read.table(file.path(projectFolder, "samples.tsv"), header = TRUE, sep = '\t', stringsAsFactors = TRUE)
```


Add the interaction group to the metadata, in order to simplify
```{r}
meta$group <- paste0(meta$Week, meta$Treatment)
meta$group <- factor(gsub("W", "", meta$group))
head(meta, n=3)
```

Get the Salmon files
```{r}
files <- dir(paste0(projectFolder, "/Salmon"),'quant.sf', recursive = TRUE, full.names = TRUE)
head(files)
```

Extract Sample ID from filenames and check if all files are present
```{r}
mvec <- basename(dirname((files)))
if (! all(meta$Name %in% mvec)) {
  stop("Metadata doesn't match samples")
} else {
  print("All files present")
}
```

Get the proper paths for the each Salmon quant.sf file
```{r}
files <- paste0(projectFolder, "/Salmon/", meta$Name, "/quant.sf")
```

Import transcript id to gene id table
```{r cache=TRUE, results="hide", message=FALSE}
tx2gene <- read.table(paste0(projectFolder,"/tx2gene.tsv"), header = TRUE, sep = '\t', stringsAsFactors = FALSE)
txi <- tximport(files, type="salmon", tx2gene=tx2gene)
```

Import data as a DESeq object and place the sample names to the columns
```{r message=FALSE}
ddsMatrix <- DESeqDataSetFromTximport(txi, colData=meta, ~group)
colnames(ddsMatrix) <- meta$Sample
```
Some genes (5887) have 0 expression accross all samples we can remove them
```{r}
ddsMatrix <- ddsMatrix[(rowSums(counts(ddsMatrix)) > 0),]
```

# QA
## PCA
We use blind vst to plot a PCA and check for patterns and outliers

```{r}
vsd.QA <- vst(ddsMatrix, blind=TRUE)
```

```{r}
geneNumber <- length(rownames(assay(vsd.QA)))
plotPCA(vsd.QA, intgroup = c("Treatment", "Week"), ntop=geneNumber)
```

The PCA shows and outlier in C:W34 
To get which replicate is the outlier we use the pairs function

```{r}
pairs(~W34.C2+W34.C3+W34.C4,
      data=data.frame(t(t(assay(vsd.QA))[c('W34-C2','W34-C3','W34-C4'),])), 
      lower.panel = panel.smooth, 
      upper.panel = panel.cor,
      main="Replicate scatterplot",
      gap=0, row1attop=FALSE)
```


Sample W34.C4 has a low correlation with the other replicates, we remove it from the dds dataset and from the metadata
```{r}
meta <- meta[-grep("W34-C4", meta$Sample),]
ddsMatrix <- ddsMatrix[,-grep("W34-C4", colnames(ddsMatrix))]
```



And we apply another cleanup, 3 more genes now have 0 expression
```{r}
ddsMatrix <- ddsMatrix[(rowSums(counts(ddsMatrix)) > 0),]
```


We use vst again and then plot a PCA
```{r}
vsd.QA <- vst(ddsMatrix, blind=TRUE)
geneNumber=length(rownames(assay(vsd.QA)))
plotPCA(vsd.QA, intgroup = c("Treatment", "Week"), ntop=geneNumber) 
```