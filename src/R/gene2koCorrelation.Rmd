---
title: "gene2geneCorrelation"
author: "Alonso Serrano"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# procedure:
extract spruce DE, get expression profile
take fungal genes
profile match

ok great, so gene to gene correlation analysis, then we can take a look at the top 30(15 NE and 15 ND) and see what annotations they have. Something similar?

Simon Law  15:34
That could be interesting, but we could also pull out all the fungal genes that strongly correlate with spruce genes that are upregulated in NE and carry out functional enrichment on both the spruce genes and the fungal genes. We can then repeat this for spruce genes that are downregulated in NE.
:+1::skin-tone-2:
1



# SETUP
```{r include=T}
library(DESeq2)
library(dplyr)
library(here)

source(here("Rtoolbox/src/plotEigenGene.R"))

spruceDir <- "/mnt/picea/projects/spruce/vhurry/14_SpruceRoots_Project"
fungiDir <- "/mnt/picea/projects/spruce/vhurry/fungi-flakaliden-2011"

spruceDE <- file.path(spruceDir, "DE")
fungiDE <- file.path(fungiDir, "DE")

load(file.path(spruceDE, "ddsTreatment.RData"))
load(file.path(fungiDE, "ddsTreatment_ko.RData"))

load(file.path(spruceDE, "controlVsdData.RData"))
controlSpruceData <- controlData
load(file.path(spruceDE, "fertilisedVsdData.RData"))
fertilisedSpruceData <- fertilisedData

load(file.path(fungiDE, "controlVsdData.RData"))
controlFungiData <- controlData
load(file.path(fungiDE, "fertilisedVsdData.RData"))
fertilisedFungiData <- fertilisedData

#name correction, spruce rownames, have an extra dash
rownames(controlSpruceData) <- gsub("-", "", rownames(controlSpruceData))
rownames(fertilisedSpruceData) <- gsub("-", "", rownames(fertilisedSpruceData))
```

Auxiliary functions
```{r}
getPlotData <-function(data1, genes1, group1, time1) {
  p1 <- plotEigengene(data1, genes1, group1, time1)
  p1.data <- p1$data %>%
    group_by(x) %>%
    summarise(n = n(), y = mean(y, na.rm = TRUE) )
  return(p1.data)
}

geneProfileSimilarity <- function(data1, data2, genes1, genes2, 
                              group1, group2, time1, time2, name1, name2, scoreLabel){
  

  res <- data.frame(name1 = character(),
                    name2 = character(), 
                    score = double(), 
                    stringsAsFactors = FALSE) 
  
  for (gen1 in genes1) {

    if (gen1 %in% colnames(data1)) {
      profile1 <- getPlotData(data1, gen1, group1, time1)$y
      
      for (gen2 in genes2) {

        if (gen2 %in% colnames(data2)) {
          profile2 <- getPlotData(data2, gen2, group2, time2)$y
          res <- rbind(res, c(gen1, gen2, 
                             cor(profile1, profile2, method = c("spearman"))), stringsAsFactors = FALSE)
        } #else { next }
      }
    } #else { next }

  }  

  names(res) <- c(name1, name2, scoreLabel)
  res[[scoreLabel]] <- as.numeric(res[[scoreLabel]])
  return(res)
}
```


Extract the metadata
```{r}
controlSpruceGroup <- substr(rownames(controlSpruceData),4,4)
controlSpruceTime <- as.integer(substr(rownames(controlSpruceData),2,3))

controlFungiGroup <- substr(rownames(controlFungiData),4,4)
controlFungiTime <- as.integer(substr(rownames(controlFungiData),2,3))

fertilisedSpruceGroup <- substr(rownames(fertilisedSpruceData),4,4)
fertilisedSpruceTime <- as.integer(substr(rownames(fertilisedSpruceData),2,3))

fertilisedFungiGroup <- substr(rownames(fertilisedFungiData),4,4)
fertilisedFungiTime <- as.integer(substr(rownames(fertilisedFungiData),2,3))

```


Spruce Results filtering
```{r}
spruceResults <- results(ddsSpruceTreatment)

spruceFiltered <- data.frame(spruceResults) %>% 
  filter(padj<0.01 & !is.na(padj) & abs(log2FoldChange)>0.5 )

spruceMax <- spruceFiltered %>%
  slice_max(log2FoldChange, n=15)

spruceMin <- spruceFiltered %>%
  slice_min(log2FoldChange, n=15)

spruceMaxGenes <- rownames(spruceMax)
spruceMinGenes <- rownames(spruceMin)
```


Fungi results filtering
```{r}
fungiResults <- results(ddsFungiTreatment)

fungiFiltered <- data.frame(fungiResults) %>% 
  filter(padj<0.01 & !is.na(padj) & abs(log2FoldChange)>0.5 )

fungiKOs <- rownames(fungiFiltered)
```

(data1, data2, genes1, genes2, 
                              group1, group2, time1, time2, name1, name2)
                              
```{r}
spruceMax2KO_ND <- geneProfileSimilarity(controlSpruceData,
                      controlFungiData,
                      spruceMaxGenes,
                      fungiKOs,
                      controlSpruceGroup, 
                      controlFungiGroup, 
                      controlSpruceTime, 
                      controlFungiTime,
                      "spruce",
                      "fungi_KO",
                      "control_score")

spruceMax2KO_ND.sort <- spruceMax2KO_ND[order(spruceMax2KO_ND$control_score, decreasing = T),]
```

```{r}
spruceMax2KO_NE <- geneProfileSimilarity(fertilisedSpruceData,
                      fertilisedFungiData,
                      spruceMaxGenes,
                      fungiKOs,
                      fertilisedSpruceGroup, 
                      fertilisedFungiGroup, 
                      fertilisedSpruceTime, 
                      fertilisedFungiTime,
                      "spruce",
                      "fungi_KO",
                      "fertilised_score")

spruceMax2KO_NE.sort <- spruceMax2KO_NE[order(spruceMax2KO_NE$fertilised_score, decreasing = T),]
```

```{r}
spruceMaxCombined <- left_join(spruceMax2KO_ND.sort, spruceMax2KO_NE.sort, by = c("spruce" = "spruce", "fungi_KO" = "fungi_KO"))

# clean rows with NAs
spruceMaxCombined <- spruceMaxCombined[!(is.na(spruceMaxCombined$control_score) | is.na(spruceMaxCombined$fertilised_score)),]

spruceMaxCombined$degradation <- spruceMaxCombined$control_score - spruceMaxCombined$fertilised_score
```




```{r}
#MA_10372670g0010   K11559     0.7052632     -0.028070175  0.73333333
par(mfrow=c(2,2))
plotEigengene(controlSpruceData, "MA_10372670g0010", controlSpruceGroup, controlSpruceTime, title = "Spruce control - MA_10372670g0010")

plotEigengene(fertilisedSpruceData, "MA_10372670g0010", fertilisedSpruceGroup, fertilisedSpruceTime, title = "Spruce fertilised - MA_10372670g0010")

plotEigengene(controlFungiData, "K11559", controlFungiGroup, controlFungiTime, title = "Fungi control - K11559")

plotEigengene(fertilisedFungiData, "K11559", fertilisedFungiGroup, fertilisedFungiTime, title = "Fungi fertilised - K11559")
```


