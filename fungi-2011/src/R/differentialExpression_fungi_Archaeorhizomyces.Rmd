---
title: "Fungi 2011 project - Differential expression and enrichment analysis for Archaeorhizomyces"
author: "Alonso Serrano"
date: "`r Sys.Date()`"
output:
 html_document:
   toc: true
   number_sections: true
---

# Introduction
This file contains the script and results for the differential expression analysis, based on the 
Flakaliden 2011 fungi data applied to:   
Archaeorhizomyces borealis  
Archaeorhizomyces finlayi  


# Setup
Load libraries and scripts
```{r, message=FALSE}
library(DESeq2)
library(tximport)
library(BiocParallel)
library(plotly)
library(dplyr)
library(here)
library(tidyr)
library(tibble)
library(jsonlite)
library(treemap)
library(RColorBrewer)
library(ggplot2)
library(reshape2)

register(MulticoreParam(4))

source(here("Rtoolbox/src/utilsDE.r"))
source(here("Rtoolbox/src/plotEigenGene.R"))
source(here("Rtoolbox/src/plotInteractivePCA.R"))
source(here("Rtoolbox/src/plotEnrichedTreemap.R"))
source(here("Rtoolbox/src/plotUpAndDown.R"))
source(here("UPSCb-common/src/R/gopher.R"))

```


Set the project folder

```{r}
projectFolder <- "/mnt/picea/projects/spruce/vhurry/fungi-flakaliden-2011"
deFolder <- file.path(projectFolder,"DE")
dataFolder <- file.path(projectFolder,"data")
load(file.path(dataFolder, "megaData.RData") )
```



Extract and prepare Archaeorhizomyces finlayi data
```{r}
finlayiData <- megaData[megaData$species == "Archaeorhizomyces finlayi", c(1:112)]
rownames(finlayiData) <- finlayiData$gene
finlayiData <- finlayiData[,-1]

finlayiMeta <- data.frame(week=substr(colnames(finlayiData),2,3),
                          treatment=substr(colnames(finlayiData),4,4))
finlayiMeta$treatment <- ifelse(finlayiMeta$treatment == "C", "control", "fertilised")
finlayiMeta$treatment <- as.factor(finlayiMeta$treatment)
head(finlayiMeta, n=3)
```

Extract and prepare Archaeorhizomyces borealis data
```{r}
borealisData <- megaData[megaData$species == "Archaeorhizomyces borealis", c(1:112)]
rownames(borealisData) <- borealisData$gene
borealisData <- borealisData[,-1]

borealisMeta <- data.frame(week=substr(colnames(borealisData),2,3),
                          treatment=substr(colnames(borealisData),4,4))
borealisMeta$treatment <- ifelse(borealisMeta$treatment == "C", "control", "fertilised")
borealisMeta$treatment <- as.factor(borealisMeta$treatment)
head(borealisMeta, n=3)
```


Import data as a DESeq object and clean 0 sum rows and columns
```{r deImportFinlayi, message=FALSE}
ddsFinlayi <- DESeqDataSetFromMatrix(finlayiData, colData=finlayiMeta, design=~treatment)
ddsFinlayi <- ddsFinlayi[(rowSums(counts(ddsFinlayi)) > 0),]
ddsFinlayi <- ddsFinlayi[,(colSums(counts(ddsFinlayi)) > 0)]
ddsFinlayi <- estimateSizeFactors(ddsFinlayi, type="poscounts")
```

```{r deImportBorealis, message=FALSE}
ddsBorealis <- DESeqDataSetFromMatrix(borealisData, colData=borealisMeta, design=~treatment)
ddsBorealis <- ddsBorealis[(rowSums(counts(ddsBorealis)) > 0),]
ddsBorealis <- ddsBorealis[,(colSums(counts(ddsBorealis)) > 0)]
ddsBorealis <- estimateSizeFactors(ddsBorealis, type="poscounts")
```


# QA
## PCA
We use blind vst to plot a PCA and check for patterns and outliers
```{r vsdBlind}
vsdFinlayi.QA <- varianceStabilizingTransformation(ddsFinlayi, blind=TRUE, fitType = 'local')
vsdBorealis.QA <- varianceStabilizingTransformation(ddsBorealis, blind=TRUE, fitType = 'local')
```

Interactive PCA A.Finlayi
```{r message=FALSE, warning=FALSE}
plotInteractivePCA(t(assay(vsdFinlayi.QA)),
          meta=data.frame(week=vsdFinlayi.QA$week, treatment=vsdFinlayi.QA$treatment), 
          group=c("treatment"),
          colors=c("#009444","#BE9230") )
```

Interactive PCA A.Borealis
```{r message=FALSE, warning=FALSE}
plotInteractivePCA(t(assay(vsdBorealis.QA)),
          meta=data.frame(week=vsdBorealis.QA$week, treatment=vsdBorealis.QA$treatment), 
          group=c("treatment"), 
          colors=c("#009444","#BE9230") )
```



# Differential Expression
The dataset is ready for DESeq2. We check the design of the DE object 

```{r}
design(ddsFinlayi)
design(ddsBorealis)
```

## Run DESeq
```{r runDEfinlayi, eval=T, message=FALSE, warning=FALSE}
ddsFinlayi <- DESeq(ddsFinlayi)
```

```{r runDEborealis, eval=T, message=FALSE, warning=FALSE}
ddsBorealis <- DESeq(ddsBorealis)
```

We check the result names
```{r}
resultsNames(ddsFinlayi)
resultsNames(ddsBorealis)
```

## Fertilised vs Control comparitions
For this comparition we take DE genes due to fertilisation

```{r eval=T}
resFinlayi <- list(FertilisedvsControl = results(ddsFinlayi,
        name= "treatment_fertilised_vs_control",
        filter = rowMedians(counts(ddsFinlayi )),
        parallel = FALSE) 
        )

resBorealis <- list(FertilisedvsControl = results(ddsBorealis,
        name= "treatment_fertilised_vs_control",
        filter = rowMedians(counts(ddsBorealis )),
        parallel = FALSE) 
        )
```

## Filtering
We filter the data by padj = 0.01 and lfc= 0.5
```{r}
resFinlayi.filter <- lapply(resFinlayi, filterDE)
resBorealis.filter <- lapply(resBorealis, filterDE)
```

## Plot DE genes
We can plot the results as positive and negative bars to reflect the amount of genes up or down
regulated in each comparition 

### A.Finlayi DE genes plot
```{r}
plotUpAndDown(resFinlayi.filter)
```

### A.Borealis DE genes plot
```{r}
plotUpAndDown(resBorealis.filter)
```

## DE genes expression profiles

Separate up and down regulated genes in both species and check the amount of genes in each category
```{r}
finlayiGenes.up <- rownames(resFinlayi.filter$FertilisedvsControl[resFinlayi.filter$FertilisedvsControl$log2FoldChange> 0,])
length(finlayiGenes.up)

finlayiGenes.down <- rownames(resFinlayi.filter$FertilisedvsControl[resFinlayi.filter$FertilisedvsControl$log2FoldChange< 0,])
length(finlayiGenes.down)

borealisGenes.up <- rownames(resBorealis.filter$FertilisedvsControl[resBorealis.filter$FertilisedvsControl$log2FoldChange> 0,])
length(borealisGenes.up)

borealisGenes.down <- rownames(resBorealis.filter$FertilisedvsControl[resBorealis.filter$FertilisedvsControl$log2FoldChange< 0,])
length(borealisGenes.down)
```

Both species down regulated genes have 0 or 1 gene. The expression profile will be plotted using up regulated genes,
those favored due to a fertilisation effect.

Data transformation using a design aware model
```{r}
vsdFinlayi <- varianceStabilizingTransformation(ddsFinlayi, blind=F, fitType = 'local')
vsdBorealis <- varianceStabilizingTransformation(ddsBorealis, blind=F, fitType = 'local')
```

### A. finlayi expression profile through the season
```{r}
plotEigengene(t(assay(vsdFinlayi)), 
              finlayiGenes.up, 
              ddsFinlayi$treatment, 
              ddsFinlayi$week, 
              timeUnits="Week", 
              title="Eigengene of fertilisation up regulated genes in A.finlayi ")

```

### A. borealis expression profile through the season
```{r}
plotEigengene(t(assay(vsdBorealis)), 
              borealisGenes.up, 
              ddsBorealis$treatment, 
              ddsBorealis$week, 
              timeUnits="Week", 
              title="Eigengene of fertilisation up regulated genes in A.borealis ")

```


# Enrichment

```{r eval=FALSE, include=FALSE}
## Up and down regulated compared to all species specific genes
finlayiGenes.up <- rownames(resFinlayi.filter$FertilisedvsControl[resFinlayi.filter$FertilisedvsControl$log2FoldChange> 0,])
finlayiGenes.down <- rownames(resFinlayi.filter$FertilisedvsControl[resFinlayi.filter$FertilisedvsControl$log2FoldChange< 0,])
# there is no finlayi down regulated after filtering

borealisGenes.up <- rownames(resBorealis.filter$FertilisedvsControl[resBorealis.filter$FertilisedvsControl$log2FoldChange> 0,])
borealisGenes.down <- rownames(resBorealis.filter$FertilisedvsControl[resBorealis.filter$FertilisedvsControl$log2FoldChange< 0,])
```

```{r eval=FALSE, include=FALSE}
## Background for enrichment
finlayiBackground <- rownames(ddsFinlayi)
borealisBackground <- rownames(ddsBorealis)
```

```{r eval=FALSE, include=FALSE}
## Run enrichment tests
finlayiGenes.up.enr <- gopher(finlayiGenes.up, background=finlayiBackground, url='fungi2011', task=list('cog','ko','kog','ko_pathway'))
borealisGenes.up.enr <- gopher(borealisGenes.up, background=borealisBackground, url='fungi2011', task=list('cog','ko','kog','ko_pathway'))
borealisGenes.down.enr <- gopher(borealisGenes.down, background=borealisBackground, url='fungi2011', task=list('cog','ko','kog','ko_pathway'))
```


## Species enrichment vs all community
All results have a p-adjusted value lower than 0.05
```{r}
finlayiGenes.enr <- gopher(rownames(ddsFinlayi), url='fungi2011', task=list('cog','ko','ko_pathway', 'kog'))
borealisGenes.enr <- gopher(rownames(ddsBorealis), url='fungi2011', task=list('cog','ko','ko_pathway', 'kog'))
```

```{r include=FALSE}
source("~/scripts/koPathwayDiseaesCleanup/koProcessing.R")
finlayiGenes.enr$ko_pathway <- koPathwayDiseaseCleanup(koTranslate(finlayiGenes.enr$ko_pathway))
finlayiGenes.enr$ko <- koPathwayDiseaseCleanup(koTranslate(finlayiGenes.enr$ko))
borealisGenes.enr$ko <- koPathwayDiseaseCleanup(koTranslate(borealisGenes.enr$ko))
borealisGenes.enr$ko_pathway <-koPathwayDiseaseCleanup(koTranslate(borealisGenes.enr$ko_pathway))
```

### A.finlayi treemaps
```{r}
none <- lapply(c('cog','ko','kog','ko_pathway'), function(x){
  if (!is.null(finlayiGenes.enr[[x]]) ) {
    plotEnrichedTreemap(finlayiGenes.enr, enrichment = x, namespace = "none", title = paste("Archaeorhizomyces finlayi",x,"enrichment"))
  }
})

```

### A.borealis treemaps
```{r message=FALSE, warning=FALSE}
none <- lapply(c('cog','ko','kog','ko_pathway'), function(x){
  if (!is.null(borealisGenes.enr[[x]]) ) {
    plotEnrichedTreemap(borealisGenes.enr, enrichment = x, namespace = "none", title = paste("Archaeorhizomyces borealis ",x,"enrichment"))
  }
})

```



# Session information
```{r}
sessionInfo()
```
